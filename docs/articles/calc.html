<!-- Generated by pkgdown: do not edit by hand -->
<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Calculate Indicators • gmbi</title>

<!-- jquery -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<!-- Bootstrap -->

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script>

<!-- Font Awesome icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />

<!-- clipboard.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script>

<!-- sticky kit -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script>

<!-- pkgdown -->
<link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script>



<meta property="og:title" content="Calculate Indicators" />

<meta property="og:description" content="" />
<meta name="twitter:card" content="summary" />



<!-- mathjax -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script>

<!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->


  </head>

  <body>
    <div class="container template-article">
      <header>
      <div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gmbi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="../articles/calc.html">Calculate Indicators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
      
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="https://github.com/marinebon/gmbi">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
      
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      
      </header>


<div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Calculate Indicators</h1>
                        <h4 class="author">Ben Best</h4>
            
            <h4 class="date">2019-03-11</h4>
      
      <small class="dont-index">Source: <a href='https://github.com/marinebon/gmbi/blob/master/vignettes/calc.Rmd'><code>vignettes/calc.Rmd</code></a></small>
      <div class="hidden name"><code>calc.Rmd</code></div>

    </div>

    
    
<div id="setup-database" class="section level2">
<h2>Setup database</h2>
<p>Using PostgreSQL with PostGIS extension in <a href="https://www.docker.com/get-started">Docker</a>:</p>
<ul>
<li><p><a href="https://hub.docker.com/r/kartoza/postgis/">kartoza/postgis - Docker Hub</a></p></li>
<li><p><a href="https://alexurquhart.com/post/set-up-postgis-with-docker/">Set Up a PostGIS Database With Docker · Alex Urquhart</a></p></li>
</ul>
<div id="create-volume-pg_data" class="section level3">
<h3>create volume <code>pg_data</code></h3>
<pre><code>docker volume create pg_data</code></pre>
</div>
<div id="create-container-postgis-database-am-user-admin" class="section level3">
<h3>create container <code>postgis</code>, database <code>am</code> user <code>admin</code></h3>
<p>On command line:</p>
<pre><code># set password as environment variable read in from file
DB_PASS=`cat ~/private/pg_pass`

# run docker with image
docker run --name=postgis \
  -d -e POSTGRES_USER=admin \
  -e POSTGRES_PASS=$DB_PASS \
  -e POSTGRES_DBNAME=am \
  -e ALLOW_IP_RANGE=0.0.0.0/0 \
  -p 5432:5432 \
  -v pg_data:/var/lib/postgresql \
  -v /Users/bbest/docker_pg_data:/data \
  --restart=always \
  --shm-size=1g \
  kartoza/postgis:11.0-2.5

# check logs
docker logs postgis</code></pre>
</div>
</div>
<div id="connect-to-database" class="section level2">
<h2>Connect to database</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="kw">library</span>(here)
<span class="kw">library</span>(glue)
<span class="kw">library</span>(raster)
<span class="kw">library</span>(DBI)
<span class="kw">library</span>(RPostgreSQL)
<span class="kw">library</span>(tictoc)
<span class="kw">library</span>(furrr)
<span class="kw">library</span>(RColorBrewer)

<span class="kw">library</span>(devtools); <span class="kw">load_all</span>() <span class="co"># library(gmbi)</span>

<span class="co"># paths</span>
dir_out      &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data-raw/rasters&quot;</span>)
dir_tmp      &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;inst/tmp&quot;</span>)
spp_iucn_csv &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data-raw/spp_iucn.csv&quot;</span>)
spp_csv      &lt;-<span class="st"> </span><span class="kw">here</span>(<span class="st">&quot;data-raw/spp.csv&quot;</span>)

<span class="co"># plotting parameters</span>
pal &lt;-<span class="st"> </span><span class="kw">colorRampPalette</span>(<span class="kw">brewer.pal</span>(<span class="dv">11</span>, <span class="st">&quot;Spectral&quot;</span>))
cols &lt;-<span class="st"> </span><span class="kw">rev</span>(<span class="kw">pal</span>(<span class="dv">255</span>))
<span class="kw">par</span>(<span class="dt">mar=</span><span class="kw">c</span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>))

<span class="co"># database connection</span>
con &lt;-<span class="st"> </span><span class="kw">get_db_con</span>(<span class="dt">password=</span><span class="kw">readLines</span>(<span class="st">&quot;~/private/pg_pass&quot;</span>))
con</code></pre></div>
<pre><code>## &lt;PostgreSQLConnection&gt;</code></pre>
</div>
<div id="load-aquamaps-csvs-into-database" class="section level2">
<h2>Load AquaMaps csvs into database</h2>
<p>All the species distribution data was generously provided as comma-seperated value (csv) files in a zip package <code>aquamaps_ver0816c.zip</code> by Kristin Kaschner and Cristina Garilao to Ben Best <a href="mailto:ben@ecoquants.com">ben@ecoquants.com</a> on Jun 21, 2018 from the extensive work available at <a href="http://AquaMaps.org" class="uri">http://AquaMaps.org</a> to be fully cited <span class="citation">(K. Kaschner et al. 2016)</span> whenever used.</p>
<p>Generated here are derived products. Please contact Kristin Kaschner <a href="mailto:kristin.kaschner@biologie.uni-freiburg.de">kristin.kaschner@biologie.uni-freiburg.de</a> and Cristina Garilao <a href="mailto:cgarilao@geomar.de">cgarilao@geomar.de</a> for access to the full database.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">csv_to_db</span>(con)

<span class="co"># drop odd columns</span>
<span class="kw">dbExecute</span>(con, <span class="st">&#39;ALTER TABLE spp DROP COLUMN &quot;X11&quot;, DROP COLUMN &quot;X12&quot;;&#39;</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">genus_species =</span> <span class="kw">glue</span>(<span class="st">&quot;{Genus} {Species}&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">as.character</span>())

<span class="kw">copy_to</span>(
  con, spp, <span class="st">&quot;spp&quot;</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
  <span class="dt">unique_indexes=</span><span class="kw">list</span>(<span class="st">&quot;SPECIESID&quot;</span>),
  <span class="dt">indexes =</span> <span class="kw">list</span>(<span class="st">&quot;group&quot;</span>, <span class="st">&quot;genus_species&quot;</span>))</code></pre></div>
<p>Load tables for querying.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;cells&quot;</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp_cells&quot;</span>)
obs_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;obs_cells&quot;</span>)</code></pre></div>
</div>
<div id="assign-taxonomic-groups" class="section level2">
<h2>Assign taxonomic groups</h2>
<p>Assign taxonomic groups borrowing from previous global OBIS analysis <span class="citation">(Tittensor et al. 2010)</span>.</p>
<ul>
<li>Primarily coastal species <span class="citation">(Tittensor et al. 2010)</span>
<ul>
<li><strong>Coastal fishes</strong>: <code>Class == &quot;Actinopterygii&quot; &amp; !Family %in% c(&quot;Scombridae&quot;, &quot;Istiophoridae&quot;, &quot;Xiphiidae&quot;)</code></li>
<li>Non-oceanic sharks: TODO with <code>rredlist::rl_habitats()</code></li>
<li><strong>Non-squid cephalopods</strong>: <code>Class == &quot;Cephalopoda&quot; &amp; !Order %in% c(&quot;Myopsida&quot;,&quot;Oegopsida&quot;)</code></li>
<li><strong>Pinnipeds</strong>: <code>Family %in% c(&quot;Odobenidae&quot;, &quot;Otariidae&quot;, &quot;Phocidae&quot;)</code></li>
<li><strong>Corals</strong>: <code>Class == &quot;Anthozoa&quot;</code> (soft/hard + anemones + gorgonians)</li>
<li><strong>Seagrasses</strong>: <code>Order == &quot;Alismatales&quot;</code></li>
<li><strong>Mangroves</strong>: <code>Genus == &quot;Avicennia&quot; &amp; Species == &quot;germinans&quot;</code> (n=1)</li>
</ul></li>
<li>Primarily oceanic species <span class="citation">(Tittensor et al. 2010)</span>
<ul>
<li><strong>Tunas and billfishes</strong>: <code>Family %in% c(&quot;Scombridae&quot;, &quot;Istiophoridae&quot;, &quot;Xiphiidae&quot;)</code></li>
<li>Oceanic sharks: TODO with <code>rredlist::rl_habitats()</code></li>
<li><strong>Squids</strong>: <code>Order %in% c(&quot;Myopsida&quot;,&quot;Oegopsida&quot;)</code></li>
<li><strong>Cetaceans</strong>: <code>Order == &quot;Artiodactyla&quot;</code></li>
<li><strong>Euphausiids</strong>: <code>Order == &quot;Euphausiacea&quot;</code></li>
<li>Foraminifera: n=0 for Phylum=Retaria</li>
</ul></li>
<li>Others (Phylum - Class)
<ul>
<li>Arthropoda
<ul>
<li><strong>Crustaceans</strong>: <code>Class %in% c(&quot;Malacostraca&quot;,&quot;Ostracoda&quot;,&quot;Branchiopoda&quot;,&quot;Cephalocarida&quot;,&quot;Maxillopoda&quot;)</code></li>
<li><strong>Sea spiders</strong>: <code>Class == &quot;Pycnogonida&quot;</code></li>
<li>skipping: Arachnida (1), Merostomata (1)</li>
</ul></li>
<li>Mollusca
<ul>
<li><strong>Gastropods</strong>: <code>Class == &quot;Gastropoda&quot;</code></li>
<li><strong>Bivalves</strong>: <code>Class == &quot;Bivalvia&quot;</code></li>
<li><strong>Chitons</strong>: <code>Class == &quot;Polyplacophora&quot;</code></li>
<li>Cephalopods</li>
<li>Squids</li>
</ul></li>
<li>Chordata
<ul>
<li><strong>Tunicates</strong>: <code>Class %in% c(&quot;Ascidiacea&quot;,&quot;Thaliacea&quot;)</code></li>
<li><strong>Sharks</strong>: <code>Class == &quot;Elasmobranchii&quot;</code> (actually Class=Chondrichthyes, Subclass=Elasmobranchii)</li>
<li><strong>Reptiles</strong>: <code>Class == &quot;Reptilia&quot;</code> crocodiles, sea snakes &amp; sea turtles</li>
</ul></li>
<li><strong>Echinoderms</strong>: <code>Phylum == &quot;Echinodermata&quot;</code></li>
<li><strong>Sponges</strong>: <code>Phylum == &quot;Porifera&quot;</code></li>
<li><strong>Worms</strong>: <code>Phylum == &quot;Annelida&quot;</code></li>
<li>Cnidaria
<ul>
<li><strong>Hydrozoans</strong>: <code>Class == &quot;Hydrozoa&quot;</code></li>
</ul></li>
</ul></li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()

<span class="cf">if</span> (<span class="op">!</span><span class="st">&quot;group&quot;</span> <span class="op">%in%</span><span class="st"> </span>spp_cols){

  spp &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">group =</span> <span class="kw">case_when</span>(
        Class <span class="op">==</span><span class="st"> &quot;Actinopterygii&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>Family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Scombridae&quot;</span>, <span class="st">&quot;Istiophoridae&quot;</span>, <span class="st">&quot;Xiphiidae&quot;</span>) <span class="op">~</span><span class="st"> &quot;Coastal fishes&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Cephalopoda&quot;</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>Order <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Myopsida&quot;</span>,<span class="st">&quot;Oegopsida&quot;</span>) <span class="op">~</span><span class="st"> &quot;Non-squid cephalopods&quot;</span>,
        Family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Odobenidae&quot;</span>, <span class="st">&quot;Otariidae&quot;</span>, <span class="st">&quot;Phocidae&quot;</span>) <span class="op">~</span><span class="st"> &quot;Pinnipeds&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Anthozoa&quot;</span> <span class="op">~</span><span class="st"> &quot;Corals&quot;</span>,
        Order <span class="op">==</span><span class="st"> &quot;Alismatales&quot;</span> <span class="op">~</span><span class="st"> &quot;Seagrasses&quot;</span>,
        Genus <span class="op">==</span><span class="st"> &quot;Avicennia&quot;</span> <span class="op">&amp;</span><span class="st"> </span>Species <span class="op">==</span><span class="st"> &quot;germinans&quot;</span> <span class="op">~</span><span class="st"> &quot;Mangroves&quot;</span>,
        Family <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Scombridae&quot;</span>, <span class="st">&quot;Istiophoridae&quot;</span>, <span class="st">&quot;Xiphiidae&quot;</span>) <span class="op">~</span><span class="st"> &quot;Tunas &amp; billfishes&quot;</span>,
        Order <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Myopsida&quot;</span>,<span class="st">&quot;Oegopsida&quot;</span>) <span class="op">~</span><span class="st"> &quot;Squids&quot;</span>,
        Order <span class="op">==</span><span class="st"> &quot;Artiodactyla&quot;</span> <span class="op">~</span><span class="st"> &quot;Cetaceans&quot;</span>,
        Order <span class="op">==</span><span class="st"> &quot;Euphausiacea&quot;</span> <span class="op">~</span><span class="st"> &quot;Euphausiids&quot;</span>,
        Class <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Malacostraca&quot;</span>,<span class="st">&quot;Ostracoda&quot;</span>,<span class="st">&quot;Branchiopoda&quot;</span>,<span class="st">&quot;Cephalocarida&quot;</span>,<span class="st">&quot;Maxillopoda&quot;</span>) <span class="op">~</span><span class="st"> &quot;Crustaceans&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Pycnogonida&quot;</span> <span class="op">~</span><span class="st"> &quot;Sea spiders&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Gastropoda&quot;</span> <span class="op">~</span><span class="st"> &quot;Gastropods&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Bivalvia&quot;</span> <span class="op">~</span><span class="st"> &quot;Bivalves&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Polyplacophora&quot;</span> <span class="op">~</span><span class="st"> &quot;Chitons&quot;</span>,
        Class <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Ascidiacea&quot;</span>,<span class="st">&quot;Thaliacea&quot;</span>) <span class="op">~</span><span class="st"> &quot;Tunicates&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Elasmobranchii&quot;</span> <span class="op">~</span><span class="st"> &quot;Sharks&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Reptilia&quot;</span><span class="op">~</span><span class="st"> &quot;Reptiles&quot;</span>,
        Phylum <span class="op">==</span><span class="st"> &quot;Echinodermata&quot;</span><span class="op">~</span><span class="st"> &quot;Echinoderms&quot;</span>,
        Phylum <span class="op">==</span><span class="st"> &quot;Porifera&quot;</span> <span class="op">~</span><span class="st"> &quot;Sponges&quot;</span>,
        Phylum <span class="op">==</span><span class="st"> &quot;Annelida&quot;</span> <span class="op">~</span><span class="st"> &quot;Worms&quot;</span>,
        Class <span class="op">==</span><span class="st"> &quot;Hydrozoa&quot;</span> <span class="op">~</span><span class="st"> &quot;Hydrozoans&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">&quot;spp&quot;</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw">list</span>(<span class="st">&quot;SPECIESID&quot;</span>),
    <span class="dt">indexes =</span> <span class="kw">list</span>(<span class="st">&quot;group&quot;</span>))
}

spp_group &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)
<span class="kw">table</span>(spp_group, <span class="dt">useNA=</span><span class="st">&quot;always&quot;</span>)</code></pre></div>
</div>
<div id="get-extinction-risk-from-iucn" class="section level2">
<h2>Get extinction risk from IUCN</h2>
<p>RedList token issued to <a href="mailto:ben@ecoquants.com">ben@ecoquants.com</a> via <a href="http://apiv3.iucnredlist.org/api/v3/token" class="uri">http://apiv3.iucnredlist.org/api/v3/token</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(spp_iucn_csv)){
  
  <span class="co"># speed up get_iucn() by running </span>
  <span class="co"># as multi-threaded process w/ furrr::future_map()</span>

  <span class="kw">plan</span>(multiprocess)
  
  <span class="co"># get private IUCN RedList token key</span>
  rl_token &lt;-<span class="st"> </span><span class="kw">readLines</span>(<span class="st">&quot;~/private/iucn_api_key&quot;</span>)
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>()

  <span class="co"># iterate in chunks of 1000</span>
  n &lt;-<span class="st"> </span><span class="dv">1000</span>
  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="kw">seq</span>(<span class="dv">1</span>, <span class="kw">nrow</span>(spp), <span class="dt">by=</span>n) ){
    i_beg &lt;-<span class="st"> </span>i
    i_end &lt;-<span class="st"> </span>i <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>n
    csv &lt;-<span class="st"> </span><span class="kw">glue</span>(<span class="st">&quot;{dir_tmp}/spp_iucn_{str_pad(i_beg, 5, &#39;left&#39;, &#39;0&#39;)}-{str_pad(i_end, 5, &#39;left&#39;, &#39;0&#39;)}.csv&quot;</span>)
    <span class="kw">cat</span>(<span class="kw">glue</span>(<span class="st">&quot;{basename(csv)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">&quot;</span>))
    
    spp_i &lt;-<span class="st"> </span><span class="kw">slice</span>(spp, i_beg<span class="op">:</span>i_end)
    <span class="kw">tic</span>()  
    spp_i<span class="op">$</span>iucn &lt;-<span class="st"> </span><span class="kw">future_map</span>(spp_i<span class="op">$</span>genus_species, get_iucn, <span class="dt">key=</span>rl_token)
    <span class="kw">toc</span>() <span class="co"># 262.211 sec; 262.211 / 1000 * 24904 / 60 = 108.8 min for all rows</span>
    
    spp_i &lt;-<span class="st"> </span>spp_i <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">iucn_category         =</span> <span class="kw">map_chr</span>(iucn, <span class="st">&quot;category&quot;</span>),
        <span class="dt">iucn_criteria         =</span> <span class="kw">map_chr</span>(iucn, <span class="st">&quot;criteria&quot;</span>),
        <span class="dt">iucn_population_trend =</span> <span class="kw">map_chr</span>(iucn, <span class="st">&quot;population_trend&quot;</span>),
        <span class="dt">iucn_published_year   =</span> <span class="kw">map_chr</span>(iucn, <span class="st">&quot;published_year&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">select</span>(SPECIESID, <span class="kw">starts_with</span>(<span class="st">&quot;iucn_&quot;</span>))
    
    <span class="kw">write_csv</span>(spp_i, csv)
  }

  <span class="co"># consolidate csvs</span>
  csvs &lt;-<span class="st"> </span><span class="kw">list.files</span>(dir_tmp, <span class="st">&quot;^spp_iucn_.*&quot;</span>, <span class="dt">full.names =</span> T)
  df &lt;-<span class="st"> </span><span class="kw">map</span>(csvs, <span class="cf">function</span>(x) <span class="kw">read_csv</span>(x)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_rows</span>()
  <span class="kw">write_csv</span>(df, csv)
  <span class="kw">unlink</span>(dir_tmp, <span class="dt">recursive =</span> T)
}
iucn &lt;-<span class="st"> </span><span class="kw">read_csv</span>(spp_iucn_csv)

iucn_cols &lt;-<span class="st"> </span>iucn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="kw">starts_with</span>(<span class="st">&quot;iucn_&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()
spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()
<span class="cf">if</span> (<span class="op">!</span><span class="kw">all</span>(iucn_cols <span class="op">%in%</span><span class="st"> </span>spp_cols)){
  <span class="co"># write to db</span>
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(df, <span class="dt">by=</span><span class="st">&quot;SPECIESID&quot;</span>)
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">&quot;spp&quot;</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw">list</span>(<span class="st">&quot;SPECIESID&quot;</span>),
    <span class="dt">indexes =</span> <span class="kw">list</span>(<span class="st">&quot;group&quot;</span>, <span class="st">&quot;genus_species&quot;</span>, <span class="st">&quot;iucn_category&quot;</span>))
}

spp_iucn_category &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(iucn_category)
<span class="kw">table</span>(spp_iucn_category, <span class="dt">useNA=</span><span class="st">&quot;always&quot;</span>)</code></pre></div>
<pre><code>## spp_iucn_category
##    CR    DD    EN    EX    LC LR/cd LR/lc LR/nt    NT    VU  &lt;NA&gt; 
##    42  1034    87     1  6183     3     4     2   309   379 16860</code></pre>
</div>
<div id="calculate-species-richness" class="section level2">
<h2>Calculate species richness</h2>
<p>Using AquaMaps probability ≥ 0.5 <span class="citation">(Klein et al. 2015; O’Hara et al. 2017)</span> to establish presence.</p>
<div id="calculate-nspp-all-taxa" class="section level3">
<h3>Calculate <code>nspp</code>, all taxa</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp_prob_threshold &lt;-<span class="st"> </span><span class="fl">0.5</span>

spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;cells&quot;</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp_cells&quot;</span>)

tif &lt;-<span class="st"> </span>(<span class="kw">glue</span>(<span class="st">&quot;{dir_out}/nspp_all.tif&quot;</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(tif)){
  
  <span class="co"># get species richness, with default col_cellid=&quot;cellid&quot;</span>
  cells_nspp &lt;-<span class="st"> </span>spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(
      probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(cells, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;CenterLat&quot;</span>,<span class="st">&quot;CenterLong&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_nspp_all &lt;-<span class="st"> </span><span class="kw">df_to_raster</span>(cells_nspp, <span class="st">&quot;nspp&quot;</span>, tif)
}

<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(tif)){
  <span class="co"># OR get species richness, with cols_lonlat=c(&quot;CenterLat&quot;,&quot;CenterLong&quot;)</span>
  cells_nspp &lt;-<span class="st"> </span>spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(
      probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_nspp_all &lt;-<span class="st"> </span><span class="kw">df_to_raster</span>(
    cells_nspp, <span class="st">&quot;nspp&quot;</span>, tif, 
    <span class="dt">col_cellid=</span><span class="ot">NULL</span>, <span class="dt">cols_lonlat=</span><span class="kw">c</span>(<span class="st">&quot;CenterLat&quot;</span>,<span class="st">&quot;CenterLong&quot;</span>))
}
r_nspp_all &lt;-<span class="st"> </span><span class="kw">raster</span>(tif)

<span class="kw">plot</span>(r_nspp_all, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">&quot;Species Richness, All&quot;</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%20for%20all-1.png" width="700" /></p>
</div>
<div id="calculate-nspp-by-taxonomic-group" class="section level3">
<h3>Calculate <code>nspp</code>, by taxonomic group</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>T
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;cells&quot;</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp_cells&quot;</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(spp_groups)){
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw">group_to_grp</span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw">glue</span>(<span class="st">&quot;{dir_out}/nspp_{grp}.tif&quot;</span>))
  
  <span class="cf">if</span> (<span class="kw">file.exists</span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw">cat</span>(<span class="kw">glue</span>(<span class="st">&quot;{str_pad(i, 2, pad=&#39;0&#39;)} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">&quot;</span>))

  <span class="co"># get species diversity, with default col_cellid=&quot;cellid&quot;</span>
  <span class="cf">if</span> (<span class="kw">is.na</span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw">filter</span>(spp, <span class="kw">is.na</span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw">filter</span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  cells_nspp &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">select</span>(SPECIESID) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">select</span>(
          SpeciesID, probability,
          CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">filter</span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;SPECIESID&quot;</span>=<span class="st">&quot;SpeciesID&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      cells, 
      <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;CenterLat&quot;</span>,<span class="st">&quot;CenterLong&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_grp &lt;-<span class="st"> </span><span class="kw">df_to_raster</span>(cells_nspp, <span class="st">&quot;nspp&quot;</span>, tif)
  <span class="kw">plot</span>(r_grp, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw">glue</span>(<span class="st">&quot;n_spp {group}&quot;</span>))
}</code></pre></div>
<pre><code>## 01 of 21: bivalves - 2019-03-11 11:28:58</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-1.png" width="700" /></p>
<pre><code>## 02 of 21: chitons - 2019-03-11 11:30:05</code></pre>
<pre><code>## 03 of 21: coastal.fishes - 2019-03-11 11:31:12</code></pre>
<pre><code>## Warning in x@data@values[i] &lt;- value: number of items to replace is not a
## multiple of replacement length</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-2.png" width="700" /><img src="calc_files/figure-html/calc%20nspp%20by%20group-3.png" width="700" /></p>
<pre><code>## 04 of 21: corals - 2019-03-11 11:32:47</code></pre>
<pre><code>## 05 of 21: crustaceans - 2019-03-11 11:33:50</code></pre>
<pre><code>## Warning in x@data@values[i] &lt;- value: number of items to replace is not a
## multiple of replacement length</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-4.png" width="700" /></p>
<pre><code>## 06 of 21: echinoderms - 2019-03-11 11:34:53</code></pre>
<pre><code>## Warning in x@data@values[i] &lt;- value: number of items to replace is not a
## multiple of replacement length</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-5.png" width="700" /><img src="calc_files/figure-html/calc%20nspp%20by%20group-6.png" width="700" /></p>
<pre><code>## 07 of 21: euphausiids - 2019-03-11 11:35:55</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-7.png" width="700" /></p>
<pre><code>## 08 of 21: gastropods - 2019-03-11 11:36:57</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-8.png" width="700" /></p>
<pre><code>## 09 of 21: hydrozoans - 2019-03-11 11:38:03</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-9.png" width="700" /></p>
<pre><code>## 10 of 21: mangroves - 2019-03-11 11:39:03</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-10.png" width="700" /></p>
<pre><code>## 11 of 21: non-squid.cephalopods - 2019-03-11 11:40:06</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-11.png" width="700" /></p>
<pre><code>## 12 of 21: pinnipeds - 2019-03-11 11:41:06</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-12.png" width="700" /></p>
<pre><code>## 13 of 21: reptiles - 2019-03-11 11:42:05</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-13.png" width="700" /></p>
<pre><code>## 14 of 21: sea.spiders - 2019-03-11 11:43:04</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-14.png" width="700" /></p>
<pre><code>## 15 of 21: seagrasses - 2019-03-11 11:44:02</code></pre>
<pre><code>## 16 of 21: sharks - 2019-03-11 11:45:00</code></pre>
<pre><code>## Warning in x@data@values[i] &lt;- value: number of items to replace is not a
## multiple of replacement length</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-15.png" width="700" /><img src="calc_files/figure-html/calc%20nspp%20by%20group-16.png" width="700" /></p>
<pre><code>## 17 of 21: sponges - 2019-03-11 11:46:02</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-17.png" width="700" /></p>
<pre><code>## 18 of 21: tunas.n.billfishes - 2019-03-11 11:48:45</code></pre>
<pre><code>## 19 of 21: tunicates - 2019-03-11 12:09:19</code></pre>
<pre><code>## Warning in x@data@values[i] &lt;- value: number of items to replace is not a
## multiple of replacement length</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-18.png" width="700" /><img src="calc_files/figure-html/calc%20nspp%20by%20group-19.png" width="700" /></p>
<pre><code>## 20 of 21: worms - 2019-03-11 12:12:02</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-20.png" width="700" /></p>
<pre><code>## 21 of 21: na - 2019-03-11 12:13:10</code></pre>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-21.png" width="700" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get all tifs, except first one &quot;nspp_all.tif&quot;</span>
tifs &lt;-<span class="st"> </span><span class="kw">list.files</span>(dir_out, <span class="st">&quot;^nspp_.*.tif$&quot;</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_nspp &lt;-<span class="st"> </span><span class="kw">stack</span>(tifs)
<span class="kw">names</span>(s_nspp) &lt;-<span class="st"> </span><span class="kw">str_replace</span>(<span class="kw">names</span>(s_nspp), <span class="st">&quot;nspp_&quot;</span>, <span class="st">&quot;&quot;</span>)
<span class="kw">plot</span>(s_nspp, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-22.png" width="700" /></p>
</div>
</div>
<div id="calculate-extinction-risk" class="section level2">
<h2>Calculate extinction risk</h2>
<p>The Red List Index (<span class="citation">(Butchart et al. 2007)</span> et al. 2007) is summarized <span class="citation">(Juslén et al. 2016)</span> as:</p>
<blockquote>
<p>The RLI [Red List Index] value was calculated by multiplying the number of taxa in each red-list category by the category weight (0 for LC, 1 for NT, 2 for VU, 3 for EN, 4 for CR, 5 for RE/EX). These products were summed and then divided by the number of taxa multiplied by the maximum weight 5 (“maximum possible denominator”). To obtain the RLI value, this sum is subtracted from 1. The index value varies between 0 and 1 (Butchart et al. 2007). The lower the value, the closer the set of taxa is heading towards extinction. If the value is 0 all the taxa are (regionally) extinct. If the value is 1 all the taxa are assessed as Least Concern.</p>
</blockquote>
<p>We will use simply the numerator, the Red List Sum (RLS), of the Red List Index (RLI) to quantify the “endangeredness” of a cell without dilution from being in a species-rich place as the RLI does when averaging the extinction risk for all assessed species.</p>
<p><span class="math display">\[RLS = \sum_{i=1}^{n_{spp}} w_i\]</span> <span class="math display">\[RLI = 1 - \frac{RLS}{n_{spp} * max(w)}\]</span></p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/IUCN_Red_List">IUCN Red List | Wikipedia</a></li>
<li><a href="https://www.iucnredlist.org/search/stats">Search | IUCN Red List</a></li>
</ul>
<p>Weights used for Red List Sum (RLS) indicator:</p>
<ul>
<li><strong>DD</strong>: <code>NA</code> - Data Deficient</li>
<li><strong>LC</strong>: <code>0</code> - Least Concern</li>
<li><strong>LR/lc</strong>: <code>0</code> - Lower Risk, least concern (1994 category)</li>
<li><strong>NT</strong>: <code>1</code> - Near Threatened</li>
<li><strong>LR/cd</strong>: <code>1</code> - Lower Risk, conservation dependent (1994 category)</li>
<li><strong>LR/nt</strong>: <code>1</code> - Lower Risk, near threatened (1994 category)</li>
<li><strong>VU</strong>: <code>2</code> - VUlnerable</li>
<li><strong>EN</strong>: <code>3</code> - ENdangered</li>
<li><strong>CR</strong>: <code>4</code> - CRitically endangered</li>
<li><strong>EW</strong>: <code>NA</code> (*not <code>5</code>) - Extinct in the Wild (n=0)</li>
<li><strong>EX</strong>: <code>NA</code> (*not <code>5</code>) - EXtinct (n=1)</li>
</ul>
<p>Note that only 1 species is listed as extinct (EX) or extinct in the wild (EW). Since the species is no longer considered present, protection is assumed to not afford any conservation value.</p>
<p>### Set <code>iucn_weight</code> to species</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iucn_category_weights =<span class="st"> </span><span class="kw">c</span>(
  <span class="dt">DD=</span><span class="ot">NA</span>, 
  <span class="dt">LC=</span><span class="dv">0</span>, <span class="st">`</span><span class="dt">LR/lc</span><span class="st">`</span>=<span class="dv">0</span>, 
  <span class="dt">NT=</span><span class="dv">1</span>, <span class="st">`</span><span class="dt">LR/cd</span><span class="st">`</span>=<span class="dv">1</span>, <span class="st">`</span><span class="dt">LR/nt</span><span class="st">`</span>=<span class="dv">1</span>, 
  <span class="dt">VU=</span><span class="dv">2</span>, 
  <span class="dt">EN=</span><span class="dv">3</span>, 
  <span class="dt">CR=</span><span class="dv">4</span>, 
  <span class="dt">EW=</span><span class="ot">NA</span>,
  <span class="dt">EX=</span><span class="ot">NA</span>)

spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()

<span class="cf">if</span> (<span class="op">!</span><span class="st">&quot;iucn_weight&quot;</span> <span class="op">%in%</span><span class="st"> </span>spp_cols){
  
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">iucn_weight =</span> <span class="kw">recode</span>(iucn_category, <span class="op">!!!</span>iucn_category_weights))
  
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">&quot;spp&quot;</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw">list</span>(<span class="st">&quot;SPECIESID&quot;</span>),
    <span class="dt">indexes =</span> <span class="kw">list</span>(<span class="st">&quot;group&quot;</span>, <span class="st">&quot;genus_species&quot;</span>, <span class="st">&quot;iucn_weight&quot;</span>))
}

<span class="co"># save spp_csv</span>
<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(spp_csv)){
  <span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">write_csv</span>(spp_csv)
}

spp_iucn_weight &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(iucn_weight)
<span class="kw">table</span>(spp_iucn_weight, <span class="dt">useNA=</span><span class="st">&quot;always&quot;</span>)</code></pre></div>
<pre><code>## spp_iucn_weight
##     0     1     2     3     4  &lt;NA&gt; 
##  6187   314   379    87    42 17895</code></pre>
<div id="calculate-rls-all-taxa" class="section level3">
<h3>Calculate <code>rls</code>, all taxa</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;cells&quot;</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp_cells&quot;</span>)

tif &lt;-<span class="st"> </span>(<span class="kw">glue</span>(<span class="st">&quot;{dir_out}/rls_all.tif&quot;</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw">file.exists</span>(tif)){
  
  <span class="co"># calculate RedList sum of weights</span>
  cells_rls &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(
      <span class="op">!</span><span class="kw">is.na</span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">select</span>(
          SpeciesID, probability,
          CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw">filter</span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;SPECIESID&quot;</span>=<span class="st">&quot;SpeciesID&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      cells, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;CenterLat&quot;</span>,<span class="st">&quot;CenterLong&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">rls =</span> <span class="kw">sum</span>(iucn_weight)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_rls_all &lt;-<span class="st"> </span><span class="kw">df_to_raster</span>(cells_rls, <span class="st">&quot;rls&quot;</span>, tif)
}

r_rls_all &lt;-<span class="st"> </span><span class="kw">raster</span>(tif)
<span class="kw">plot</span>(r_rls_all, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">&quot;Red List Sum, All&quot;</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%20for%20all-1.png" width="700" /></p>
</div>
<div id="calculate-rls-by-taxonomic-group" class="section level3">
<h3>Calculate <code>rls</code>, by taxonomic group</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>T
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;cells&quot;</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp_cells&quot;</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">&quot;spp&quot;</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(spp_groups)){
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw">group_to_grp</span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw">glue</span>(<span class="st">&quot;{dir_out}/nspp_{grp}.tif&quot;</span>))
  
  <span class="cf">if</span> (<span class="kw">file.exists</span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw">cat</span>(<span class="kw">glue</span>(<span class="st">&quot;{str_pad(i, 2, pad=&#39;0&#39;)} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">&quot;</span>))
  
  <span class="co"># filter by group</span>
  <span class="cf">if</span> (<span class="kw">is.na</span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw">filter</span>(spp, <span class="kw">is.na</span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw">filter</span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  spp_grp_w &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">filter</span>(
      <span class="op">!</span><span class="kw">is.na</span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  
  <span class="cf">if</span> (<span class="kw">nrow</span>(spp_grp_w) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
    <span class="co">#cat(glue(&quot;  all iucn_weight == NA\n&quot;, .trim=F))</span>
  } <span class="cf">else</span> {
    <span class="co"># calculate RedList sum of weights</span>
    cells_rls &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">filter</span>(
        <span class="op">!</span><span class="kw">is.na</span>(iucn_weight), 
        iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">left_join</span>(
        spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw">select</span>(
            SpeciesID, probability,
            CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw">filter</span>(
            probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
        <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;SPECIESID&quot;</span>=<span class="st">&quot;SpeciesID&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">left_join</span>(
        cells, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;CenterLat&quot;</span>,<span class="st">&quot;CenterLong&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">summarize</span>(
        <span class="dt">rls =</span> <span class="kw">sum</span>(iucn_weight)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">collect</span>()
    
    r_grp &lt;-<span class="st"> </span><span class="kw">df_to_raster</span>(cells_rls, <span class="st">&quot;rls&quot;</span>, tif) 
    <span class="kw">plot</span>(r_grp, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw">glue</span>(<span class="st">&quot;Red List Sum, {group}&quot;</span>))
  }
}</code></pre></div>
<pre><code>## 01 of 21: bivalves - 2019-03-11 12:14:23</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<pre><code>## 02 of 21: chitons - 2019-03-11 12:15:27
## 03 of 21: coastal.fishes - 2019-03-11 12:15:27</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-1.png" width="700" /></p>
<pre><code>## 04 of 21: corals - 2019-03-11 12:16:35</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-2.png" width="700" /></p>
<pre><code>## 05 of 21: crustaceans - 2019-03-11 12:17:39</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-3.png" width="700" /></p>
<pre><code>## 06 of 21: echinoderms - 2019-03-11 12:18:44</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-4.png" width="700" /></p>
<pre><code>## 07 of 21: euphausiids - 2019-03-11 12:19:46
## 08 of 21: gastropods - 2019-03-11 12:19:46</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-5.png" width="700" /></p>
<pre><code>## 09 of 21: hydrozoans - 2019-03-11 12:20:50
## 10 of 21: mangroves - 2019-03-11 12:20:50
## 11 of 21: non-squid.cephalopods - 2019-03-11 12:20:50</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-6.png" width="700" /></p>
<pre><code>## 12 of 21: pinnipeds - 2019-03-11 12:21:54</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-7.png" width="700" /></p>
<pre><code>## 13 of 21: reptiles - 2019-03-11 12:23:00</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-8.png" width="700" /></p>
<pre><code>## 14 of 21: sea.spiders - 2019-03-11 12:24:08
## 15 of 21: seagrasses - 2019-03-11 12:24:08
## 16 of 21: sharks - 2019-03-11 12:24:08</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-9.png" width="700" /></p>
<pre><code>## 17 of 21: sponges - 2019-03-11 12:25:19
## 18 of 21: tunas.n.billfishes - 2019-03-11 12:25:19</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-10.png" width="700" /></p>
<pre><code>## 19 of 21: tunicates - 2019-03-11 12:26:33
## 20 of 21: worms - 2019-03-11 12:26:33
## 21 of 21: na - 2019-03-11 12:26:33</code></pre>
<pre><code>## Warning: Missing values are always removed in SQL.
## Use `SUM(x, na.rm = TRUE)` to silence this warning</code></pre>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-11.png" width="700" /><img src="calc_files/figure-html/calc%20rls%20by%20group-12.png" width="700" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get all tifs, except first one &quot;nspp_all.tif&quot;</span>
tifs &lt;-<span class="st"> </span><span class="kw">list.files</span>(dir_out, <span class="st">&quot;^rls_.*.tif$&quot;</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_rls &lt;-<span class="st"> </span><span class="kw">stack</span>(tifs)
<span class="kw">names</span>(s_rls) &lt;-<span class="st"> </span><span class="kw">str_replace</span>(<span class="kw">names</span>(s_rls), <span class="st">&quot;rls_&quot;</span>, <span class="st">&quot;&quot;</span>)
<span class="kw">plot</span>(s_rls, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-13.png" width="700" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## <span class="al">TODO</span>: Archive db

<span class="co"># [arkdb](https://ropensci.github.io/arkdb/): archive and unarchive databases using flat files</span></code></pre></div>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2>References</h2>
<div id="refs" class="references">
<div id="ref-butchartImprovementsRedList2007">
<p>Butchart, Stuart H. M., H. Resit Akçakaya, Janice Chanson, Jonathan E. M. Baillie, Ben Collen, Suhel Quader, Will R. Turner, Rajan Amin, Simon N. Stuart, and Craig Hilton-Taylor. 2007. “Improvements to the Red List Index.” <em>PLOS ONE</em> 2 (1): e140. doi:<a href="https://doi.org/10.1371/journal.pone.0000140">10.1371/journal.pone.0000140</a>.</p>
</div>
<div id="ref-juslenApplicationRedList2016">
<p>Juslén, Aino, Juha Pykälä, Saija Kuusela, Lauri Kaila, Jaakko Kullberg, Jaakko Mattila, Jyrki Muona, Sanna Saari, and Pedro Cardoso. 2016. “Application of the Red List Index as an Indicator of Habitat Change.” <em>Biodivers Conserv</em> 25 (3): 569–85. doi:<a href="https://doi.org/10.1007/s10531-016-1075-0">10.1007/s10531-016-1075-0</a>.</p>
</div>
<div id="ref-kaschnerAquaMapsPredictedRange2016">
<p>Kaschner, K., K. Kesner-Reyes, C. Garilao, J. Rius-Barile, T. Rees, and R. Froese. 2016. “AquaMaps: Predicted Range Maps for Aquatic Species.” World Wide Web Electronic Publication.</p>
</div>
<div id="ref-kleinShortfallsGlobalProtected2015">
<p>Klein, Carissa J., Christopher J. Brown, Benjamin S. Halpern, Daniel B. Segan, Jennifer McGowan, Maria Beger, and James E. M. Watson. 2015. “Shortfalls in the Global Protected Area Network at Representing Marine Biodiversity.” <em>Scientific Reports</em> 5 (December): 17539. doi:<a href="https://doi.org/10.1038/srep17539">10.1038/srep17539</a>.</p>
</div>
<div id="ref-oharaAligningMarineSpecies2017">
<p>O’Hara, Casey C., Jamie C. Afflerbach, Courtney Scarborough, Kristin Kaschner, and Benjamin S. Halpern. 2017. “Aligning Marine Species Range Data to Better Serve Science and Conservation.” <em>PLOS ONE</em> 12 (5): e0175739. doi:<a href="https://doi.org/10.1371/journal.pone.0175739">10.1371/journal.pone.0175739</a>.</p>
</div>
<div id="ref-tittensorGlobalPatternsPredictors2010">
<p>Tittensor, Derek P., Camilo Mora, Walter Jetz, Heike K. Lotze, Daniel Ricard, Edward Vanden Berghe, and Boris Worm. 2010. “Global Patterns and Predictors of Marine Biodiversity Across Taxa.” <em>Nature</em> 466 (7310): 1098–1101. doi:<a href="https://doi.org/10.1038/nature09329">10.1038/nature09329</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2>Contents</h2>
      <ul>
      <li><a href="#setup-database">Setup database</a></li>
      <li><a href="#connect-to-database">Connect to database</a></li>
      <li><a href="#load-aquamaps-csvs-into-database">Load AquaMaps csvs into database</a></li>
      <li><a href="#assign-taxonomic-groups">Assign taxonomic groups</a></li>
      <li><a href="#get-extinction-risk-from-iucn">Get extinction risk from IUCN</a></li>
      <li><a href="#calculate-species-richness">Calculate species richness</a></li>
      <li><a href="#calculate-extinction-risk">Calculate extinction risk</a></li>
      <li><a href="#references">References</a></li>
      </ul>
    </div>
      </div>

</div>


      <footer>
      <div class="copyright">
  <p>Developed by Ben Best.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
   </div>

  

  </body>
</html>
