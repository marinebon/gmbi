<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculate Indicators • gmbi</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculate Indicators">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gmbi</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/calc.html">Calculate Indicators</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/marinebon/gmbi">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Calculate Indicators</h1>
                        <h4 class="author">Ben Best</h4>
            
            <h4 class="date">2019-06-17</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/marinebon/gmbi/blob/master/vignettes/calc.Rmd"><code>vignettes/calc.Rmd</code></a></small>
      <div class="hidden name"><code>calc.Rmd</code></div>

    </div>

    
    
<div id="setup-database" class="section level2">
<h2 class="hasAnchor">
<a href="#setup-database" class="anchor"></a>Setup database</h2>
<p>Using PostgreSQL with PostGIS extension in <a href="https://www.docker.com/get-started">Docker</a>:</p>
<ul>
<li><p><a href="https://hub.docker.com/r/kartoza/postgis/">kartoza/postgis - Docker Hub</a></p></li>
<li><p><a href="https://alexurquhart.com/post/set-up-postgis-with-docker/">Set Up a PostGIS Database With Docker · Alex Urquhart</a></p></li>
</ul>
<div id="create-volume-pg_data" class="section level3">
<h3 class="hasAnchor">
<a href="#create-volume-pg_data" class="anchor"></a>create volume <code>pg_data</code>
</h3>
<pre><code>docker volume create pg_data</code></pre>
</div>
<div id="create-container-postgis-database-am-user-admin" class="section level3">
<h3 class="hasAnchor">
<a href="#create-container-postgis-database-am-user-admin" class="anchor"></a>create container <code>postgis</code>, database <code>am</code> user <code>admin</code>
</h3>
<p>On command line:</p>
<pre><code># set password as environment variable read in from file
DB_PASS=`cat ~/private/pg_pass`

# run docker with image
docker run --name=postgis \
  -d -e POSTGRES_USER=admin \
  -e POSTGRES_PASS=$DB_PASS \
  -e POSTGRES_DBNAME=am \
  -e ALLOW_IP_RANGE=0.0.0.0/0 \
  -p 5432:5432 \
  -v pg_data:/var/lib/postgresql \
  -v /Users/bbest/docker_pg_data:/data \
  --restart=always \
  --shm-size=1g \
  kartoza/postgis:11.0-2.5

# check logs
docker logs postgis</code></pre>
</div>
</div>
<div id="connect-to-database" class="section level2">
<h2 class="hasAnchor">
<a href="#connect-to-database" class="anchor"></a>Connect to database</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyverse)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(here)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(raster)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(DBI)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(RPostgreSQL)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tictoc)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(furrr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(RColorBrewer)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(devtools); <span class="kw"><a href="https://www.rdocumentation.org/packages/devtools/topics/load_all">load_all</a></span>() <span class="co"># library(gmbi)</span></code></pre></div>
<pre><code>## ✔ Setting active project to '/Users/bbest/github/gmbi'
## ✔ Saving 'spp' to 'data/spp.rda'
## ✔ Saving 'spp_iucn' to 'data/spp_iucn.rda'</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># paths</span>
dir_tmp      &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"inst/tmp"</span>)
dir_out      &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"inst/data/rasters"</span>)
spp_iucn_csv &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"inst/data/spp_iucn.csv"</span>)
spp_csv      &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/here/topics/here">here</a></span>(<span class="st">"inst/data/spp.csv"</span>)
dir_nc       &lt;-<span class="st"> "~/docker_pg_data/aquamaps2100_nc"</span>
spp_2100_csv &lt;-<span class="st"> "~/docker_pg_data/aquamaps2100_nc.csv"</span>

<span class="co"># plotting parameters</span>
pal &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/grDevices/topics/colorRamp">colorRampPalette</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/RColorBrewer/topics/ColorBrewer">brewer.pal</a></span>(<span class="dv">11</span>, <span class="st">"Spectral"</span>))
cols &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/rev">rev</a></span>(<span class="kw">pal</span>(<span class="dv">255</span>))
<span class="kw"><a href="https://www.rdocumentation.org/packages/graphics/topics/par">par</a></span>(<span class="dt">mar=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>,<span class="fl">0.5</span>))

<span class="co"># database connection</span>
con &lt;-<span class="st"> </span><span class="kw"><a href="../reference/get_db_con.html">get_db_con</a></span>(<span class="dt">password=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readLines">readLines</a></span>(<span class="st">"~/private/pg_pass"</span>))
con</code></pre></div>
<pre><code>## &lt;PostgreSQLConnection&gt;</code></pre>
</div>
<div id="load-aquamaps-csvs-into-database" class="section level2">
<h2 class="hasAnchor">
<a href="#load-aquamaps-csvs-into-database" class="anchor"></a>Load AquaMaps csvs into database</h2>
<p>All the species distribution data was generously provided as comma-seperated value (csv) files in a zip package <code>aquamaps_ver0816c.zip</code> by Kristin Kaschner and Cristina Garilao to Ben Best <a href="mailto:ben@ecoquants.com">ben@ecoquants.com</a> on Jun 21, 2018 from the extensive work available at <a href="http://AquaMaps.org" class="uri">http://AquaMaps.org</a> to be fully cited <span class="citation">(K. Kaschner et al. 2016)</span> whenever used.</p>
<p>Generated here are derived products. Please contact Kristin Kaschner <a href="mailto:kristin.kaschner@biologie.uni-freiburg.de">kristin.kaschner@biologie.uni-freiburg.de</a> and Cristina Garilao <a href="mailto:cgarilao@geomar.de">cgarilao@geomar.de</a> for access to the full database.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../reference/csv_to_db.html">csv_to_db</a></span>(con)

<span class="co"># drop odd columns</span>
<span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbExecute">dbExecute</a></span>(con, <span class="st">'ALTER TABLE spp DROP COLUMN "X11", DROP COLUMN "X12";'</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">mutate</span>(
    <span class="dt">genus_species =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{Genus} {Species}"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/as.character">as.character</a></span>())

<span class="kw">copy_to</span>(
  con, spp, <span class="st">"spp"</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
  <span class="dt">unique_indexes=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"SPECIESID"</span>),
  <span class="dt">indexes =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"group"</span>, <span class="st">"genus_species"</span>))</code></pre></div>
<p>Load tables for querying.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells"</span>)
obs_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"obs_cells"</span>)</code></pre></div>
</div>
<div id="assign-taxonomic-groups" class="section level2">
<h2 class="hasAnchor">
<a href="#assign-taxonomic-groups" class="anchor"></a>Assign taxonomic groups</h2>
<p>Assign taxonomic groups borrowing from previous global OBIS analysis <span class="citation">(Tittensor et al. 2010)</span>.</p>
<ul>
<li>Primarily coastal species <span class="citation">(Tittensor et al. 2010)</span>
<ul>
<li>
<strong>Coastal fishes</strong>: <code>Class == "Actinopterygii" &amp; !Family %in% c("Scombridae", "Istiophoridae", "Xiphiidae")</code>
</li>
<li>Non-oceanic sharks: TODO with <code><a href="https://www.rdocumentation.org/packages/rredlist/topics/rl_habitats">rredlist::rl_habitats()</a></code>
</li>
<li>
<strong>Non-squid cephalopods</strong>: <code>Class == "Cephalopoda" &amp; !Order %in% c("Myopsida","Oegopsida")</code>
</li>
<li>
<strong>Pinnipeds</strong>: <code>Family %in% c("Odobenidae", "Otariidae", "Phocidae")</code>
</li>
<li>
<strong>Corals</strong>: <code>Class == "Anthozoa"</code> (soft/hard + anemones + gorgonians)</li>
<li>
<strong>Seagrasses</strong>: <code>Order == "Alismatales"</code>
</li>
<li>
<strong>Mangroves</strong>: <code>Genus == "Avicennia" &amp; Species == "germinans"</code> (n=1)</li>
</ul>
</li>
<li>Primarily oceanic species <span class="citation">(Tittensor et al. 2010)</span>
<ul>
<li>
<strong>Tunas and billfishes</strong>: <code>Family %in% c("Scombridae", "Istiophoridae", "Xiphiidae")</code>
</li>
<li>Oceanic sharks: TODO with <code><a href="https://www.rdocumentation.org/packages/rredlist/topics/rl_habitats">rredlist::rl_habitats()</a></code>
</li>
<li>
<strong>Squids</strong>: <code>Order %in% c("Myopsida","Oegopsida")</code>
</li>
<li>
<strong>Cetaceans</strong>: <code>Order == "Artiodactyla"</code>
</li>
<li>
<strong>Euphausiids</strong>: <code>Order == "Euphausiacea"</code>
</li>
<li>Foraminifera: n=0 for Phylum=Retaria</li>
</ul>
</li>
<li>Others (Phylum - Class)
<ul>
<li>Arthropoda
<ul>
<li>
<strong>Crustaceans</strong>: <code>Class %in% c("Malacostraca","Ostracoda","Branchiopoda","Cephalocarida","Maxillopoda")</code>
</li>
<li>
<strong>Sea spiders</strong>: <code>Class == "Pycnogonida"</code>
</li>
<li>skipping: Arachnida (1), Merostomata (1)</li>
</ul>
</li>
<li>Mollusca
<ul>
<li>
<strong>Gastropods</strong>: <code>Class == "Gastropoda"</code>
</li>
<li>
<strong>Bivalves</strong>: <code>Class == "Bivalvia"</code>
</li>
<li>
<strong>Chitons</strong>: <code>Class == "Polyplacophora"</code>
</li>
<li>Cephalopods</li>
<li>Squids</li>
</ul>
</li>
<li>Chordata
<ul>
<li>
<strong>Tunicates</strong>: <code>Class %in% c("Ascidiacea","Thaliacea")</code>
</li>
<li>
<strong>Sharks</strong>: <code>Class == "Elasmobranchii"</code> (actually Class=Chondrichthyes, Subclass=Elasmobranchii)</li>
<li>
<strong>Reptiles</strong>: <code>Class == "Reptilia"</code> crocodiles, sea snakes &amp; sea turtles</li>
</ul>
</li>
<li>
<strong>Echinoderms</strong>: <code>Phylum == "Echinodermata"</code>
</li>
<li>
<strong>Sponges</strong>: <code>Phylum == "Porifera"</code>
</li>
<li>
<strong>Worms</strong>: <code>Phylum == "Annelida"</code>
</li>
<li>Cnidaria
<ul>
<li>
<strong>Hydrozoans</strong>: <code>Class == "Hydrozoa"</code>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/headtail">head</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>()

<span class="cf">if</span> (<span class="op">!</span><span class="st">"group"</span> <span class="op">%in%</span><span class="st"> </span>spp_cols){

  spp &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">group =</span> <span class="kw">case_when</span>(
        Class <span class="op">==</span><span class="st"> "Actinopterygii"</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>Family <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Scombridae"</span>, <span class="st">"Istiophoridae"</span>, <span class="st">"Xiphiidae"</span>) <span class="op">~</span><span class="st"> "Coastal fishes"</span>,
        Class <span class="op">==</span><span class="st"> "Cephalopoda"</span> <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>Order <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Myopsida"</span>,<span class="st">"Oegopsida"</span>) <span class="op">~</span><span class="st"> "Non-squid cephalopods"</span>,
        Family <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Odobenidae"</span>, <span class="st">"Otariidae"</span>, <span class="st">"Phocidae"</span>) <span class="op">~</span><span class="st"> "Pinnipeds"</span>,
        Class <span class="op">==</span><span class="st"> "Anthozoa"</span> <span class="op">~</span><span class="st"> "Corals"</span>,
        Order <span class="op">==</span><span class="st"> "Alismatales"</span> <span class="op">~</span><span class="st"> "Seagrasses"</span>,
        Genus <span class="op">==</span><span class="st"> "Avicennia"</span> <span class="op">&amp;</span><span class="st"> </span>Species <span class="op">==</span><span class="st"> "germinans"</span> <span class="op">~</span><span class="st"> "Mangroves"</span>,
        Family <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Scombridae"</span>, <span class="st">"Istiophoridae"</span>, <span class="st">"Xiphiidae"</span>) <span class="op">~</span><span class="st"> "Tunas &amp; billfishes"</span>,
        Order <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Myopsida"</span>,<span class="st">"Oegopsida"</span>) <span class="op">~</span><span class="st"> "Squids"</span>,
        Order <span class="op">==</span><span class="st"> "Artiodactyla"</span> <span class="op">~</span><span class="st"> "Cetaceans"</span>,
        Order <span class="op">==</span><span class="st"> "Euphausiacea"</span> <span class="op">~</span><span class="st"> "Euphausiids"</span>,
        Class <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Malacostraca"</span>,<span class="st">"Ostracoda"</span>,<span class="st">"Branchiopoda"</span>,<span class="st">"Cephalocarida"</span>,<span class="st">"Maxillopoda"</span>) <span class="op">~</span><span class="st"> "Crustaceans"</span>,
        Class <span class="op">==</span><span class="st"> "Pycnogonida"</span> <span class="op">~</span><span class="st"> "Sea spiders"</span>,
        Class <span class="op">==</span><span class="st"> "Gastropoda"</span> <span class="op">~</span><span class="st"> "Gastropods"</span>,
        Class <span class="op">==</span><span class="st"> "Bivalvia"</span> <span class="op">~</span><span class="st"> "Bivalves"</span>,
        Class <span class="op">==</span><span class="st"> "Polyplacophora"</span> <span class="op">~</span><span class="st"> "Chitons"</span>,
        Class <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"Ascidiacea"</span>,<span class="st">"Thaliacea"</span>) <span class="op">~</span><span class="st"> "Tunicates"</span>,
        Class <span class="op">==</span><span class="st"> "Elasmobranchii"</span> <span class="op">~</span><span class="st"> "Sharks"</span>,
        Class <span class="op">==</span><span class="st"> "Reptilia"</span><span class="op">~</span><span class="st"> "Reptiles"</span>,
        Phylum <span class="op">==</span><span class="st"> "Echinodermata"</span><span class="op">~</span><span class="st"> "Echinoderms"</span>,
        Phylum <span class="op">==</span><span class="st"> "Porifera"</span> <span class="op">~</span><span class="st"> "Sponges"</span>,
        Phylum <span class="op">==</span><span class="st"> "Annelida"</span> <span class="op">~</span><span class="st"> "Worms"</span>,
        Class <span class="op">==</span><span class="st"> "Hydrozoa"</span> <span class="op">~</span><span class="st"> "Hydrozoans"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">"spp"</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"SPECIESID"</span>),
    <span class="dt">indexes =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"group"</span>))
}

spp_group &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(spp_group, <span class="dt">useNA=</span><span class="st">"always"</span>)</code></pre></div>
</div>
<div id="get-extinction-risk-from-iucn" class="section level2">
<h2 class="hasAnchor">
<a href="#get-extinction-risk-from-iucn" class="anchor"></a>Get extinction risk from IUCN</h2>
<p>RedList token issued to <a href="mailto:ben@ecoquants.com">ben@ecoquants.com</a> via <a href="http://apiv3.iucnredlist.org/api/v3/token" class="uri">http://apiv3.iucnredlist.org/api/v3/token</a>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(spp_iucn_csv)){
  
  <span class="co"># speed up get_iucn() by running </span>
  <span class="co"># as multi-threaded process w/ furrr::future_map()</span>

  <span class="kw">plan</span>(multiprocess)
  
  <span class="co"># get private IUCN RedList token key</span>
  rl_token &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/readLines">readLines</a></span>(<span class="st">"~/private/iucn_api_key"</span>)
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>()

  <span class="co"># iterate in chunks of 1000</span>
  n &lt;-<span class="st"> </span><span class="dv">1000</span>
  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/ncell">nrow</a></span>(spp), <span class="dt">by=</span>n) ){
    i_beg &lt;-<span class="st"> </span>i
    i_end &lt;-<span class="st"> </span>i <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>n
    csv &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_tmp}/spp_iucn_{str_pad(i_beg, 5, 'left', '0')}-{str_pad(i_end, 5, 'left', '0')}.csv"</span>)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{basename(csv)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))
    
    spp_i &lt;-<span class="st"> </span><span class="kw">slice</span>(spp, i_beg<span class="op">:</span>i_end)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/tictoc/topics/tic">tic</a></span>()  
    spp_i<span class="op">$</span>iucn &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/furrr/topics/future_map">future_map</a></span>(spp_i<span class="op">$</span>genus_species, get_iucn, <span class="dt">key=</span>rl_token)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/tictoc/topics/tic">toc</a></span>() <span class="co"># 262.211 sec; 262.211 / 1000 * 24904 / 60 = 108.8 min for all rows</span>
    
    spp_i &lt;-<span class="st"> </span>spp_i <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">iucn_category         =</span> <span class="kw">map_chr</span>(iucn, <span class="st">"category"</span>),
        <span class="dt">iucn_criteria         =</span> <span class="kw">map_chr</span>(iucn, <span class="st">"criteria"</span>),
        <span class="dt">iucn_population_trend =</span> <span class="kw">map_chr</span>(iucn, <span class="st">"population_trend"</span>),
        <span class="dt">iucn_published_year   =</span> <span class="kw">map_chr</span>(iucn, <span class="st">"published_year"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(SPECIESID, <span class="kw">starts_with</span>(<span class="st">"iucn_"</span>))
    
    <span class="kw">write_csv</span>(spp_i, csv)
  }

  <span class="co"># consolidate csvs</span>
  csvs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(dir_tmp, <span class="st">"^spp_iucn_.*"</span>, <span class="dt">full.names =</span> T)
  df &lt;-<span class="st"> </span><span class="kw">map</span>(csvs, <span class="cf">function</span>(x) <span class="kw">read_csv</span>(x)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">bind_rows</span>()
  <span class="kw">write_csv</span>(df, csv)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlink">unlink</a></span>(dir_tmp, <span class="dt">recursive =</span> T)
}
iucn &lt;-<span class="st"> </span><span class="kw">read_csv</span>(spp_iucn_csv)

iucn_cols &lt;-<span class="st"> </span>iucn <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(<span class="kw">starts_with</span>(<span class="st">"iucn_"</span>)) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>()
spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/headtail">head</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>()
<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/all">all</a></span>(iucn_cols <span class="op">%in%</span><span class="st"> </span>spp_cols)){
  <span class="co"># write to db</span>
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(df, <span class="dt">by=</span><span class="st">"SPECIESID"</span>)
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">"spp"</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"SPECIESID"</span>),
    <span class="dt">indexes =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"group"</span>, <span class="st">"genus_species"</span>, <span class="st">"iucn_category"</span>))
}

spp_iucn_category &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(iucn_category)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(spp_iucn_category, <span class="dt">useNA=</span><span class="st">"always"</span>)</code></pre></div>
<pre><code>## spp_iucn_category
##    CR    DD    EN    EX    LC LR/cd LR/lc LR/nt    NT    VU  &lt;NA&gt; 
##    42  1034    87     1  6183     3     4     2   309   379 16860</code></pre>
</div>
<div id="calculate-species-richness" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-species-richness" class="anchor"></a>Calculate species richness</h2>
<p>Using AquaMaps probability ≥ 0.5 <span class="citation">(Klein et al. 2015; O’Hara et al. 2017)</span> to establish presence.</p>
<div id="calculate-nspp-all-taxa" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-nspp-all-taxa" class="anchor"></a>Calculate <code>nspp</code>, all taxa</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp_prob_threshold &lt;-<span class="st"> </span><span class="fl">0.5</span>

spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells"</span>)

tif &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/nspp_all.tif"</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif)){
  
  <span class="co"># get species richness, with default col_cellid="cellid"</span>
  cells_nspp &lt;-<span class="st"> </span>spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(cells, <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CenterLat"</span>,<span class="st">"CenterLong"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_nspp_all &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_nspp, <span class="st">"nspp"</span>, tif)
}

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif)){
  <span class="co"># OR get species richness, with cols_lonlat=c("CenterLat","CenterLong")</span>
  cells_nspp &lt;-<span class="st"> </span>spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_nspp_all &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(
    cells_nspp, <span class="st">"nspp"</span>, tif, 
    <span class="dt">col_cellid=</span><span class="ot">NULL</span>, <span class="dt">cols_lonlat=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CenterLat"</span>,<span class="st">"CenterLong"</span>))
}
r_nspp_all &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(tif)

<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_nspp_all, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">"Species Richness, All"</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%20for%20all-1.png" width="700"></p>
</div>
<div id="calculate-nspp-by-taxonomic-group" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-nspp-by-taxonomic-group" class="anchor"></a>Calculate <code>nspp</code>, by taxonomic group</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>F
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells"</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(spp_groups)){
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw"><a href="../reference/group_to_grp.html">group_to_grp</a></span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/nspp_{grp}.tif"</span>))
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{str_pad(i, 2, pad='0')} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))

  <span class="co"># get species diversity, with default col_cellid="cellid"</span>
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  cells_nspp &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(SPECIESID) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
          SpeciesID, probability,
          CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"SpeciesID"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      cells, 
      <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CenterLat"</span>,<span class="st">"CenterLong"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_grp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_nspp, <span class="st">"nspp"</span>, tif)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_grp, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"nspp {group}"</span>))
}

<span class="co"># get all tifs, except first one "nspp_all.tif"</span>
tifs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(dir_out, <span class="st">"^nspp_.*.tif$"</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_nspp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(tifs)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_nspp) &lt;-<span class="st"> </span><span class="kw">str_replace</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_nspp), <span class="st">"nspp_"</span>, <span class="st">""</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(s_nspp, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%20by%20group-1.png" width="700"></p>
</div>
</div>
<div id="calculate-extinction-risk" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-extinction-risk" class="anchor"></a>Calculate extinction risk</h2>
<p>The Red List Index (<span class="citation">(Butchart et al. 2007)</span> et al. 2007) is summarized <span class="citation">(Juslén et al. 2016)</span> as:</p>
<blockquote>
<p>The RLI [Red List Index] value was calculated by multiplying the number of taxa in each red-list category by the category weight (0 for LC, 1 for NT, 2 for VU, 3 for EN, 4 for CR, 5 for RE/EX). These products were summed and then divided by the number of taxa multiplied by the maximum weight 5 (“maximum possible denominator”). To obtain the RLI value, this sum is subtracted from 1. The index value varies between 0 and 1 (Butchart et al. 2007). The lower the value, the closer the set of taxa is heading towards extinction. If the value is 0 all the taxa are (regionally) extinct. If the value is 1 all the taxa are assessed as Least Concern.</p>
</blockquote>
<p>We will use simply the numerator, the Red List Sum (RLS), of the Red List Index (RLI) to quantify the “endangeredness” of a cell without dilution from being in a species-rich place as the RLI does when averaging the extinction risk for all assessed species.</p>
<p><span class="math display">\[RLS = \sum_{i=1}^{n_{spp}} w_i\]</span> <span class="math display">\[RLI = 1 - \frac{RLS}{n_{spp} * max(w)}\]</span></p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/IUCN_Red_List">IUCN Red List | Wikipedia</a></li>
<li><a href="https://www.iucnredlist.org/search/stats">Search | IUCN Red List</a></li>
</ul>
<p>Weights used for Red List Sum (RLS) indicator:</p>
<ul>
<li>
<strong>DD</strong>: <code>NA</code> - Data Deficient</li>
<li>
<strong>LC</strong>: <code>0</code> - Least Concern</li>
<li>
<strong>LR/lc</strong>: <code>0</code> - Lower Risk, least concern (1994 category)</li>
<li>
<strong>NT</strong>: <code>1</code> - Near Threatened</li>
<li>
<strong>LR/cd</strong>: <code>1</code> - Lower Risk, conservation dependent (1994 category)</li>
<li>
<strong>LR/nt</strong>: <code>1</code> - Lower Risk, near threatened (1994 category)</li>
<li>
<strong>VU</strong>: <code>2</code> - VUlnerable</li>
<li>
<strong>EN</strong>: <code>3</code> - ENdangered</li>
<li>
<strong>CR</strong>: <code>4</code> - CRitically endangered</li>
<li>
<strong>EW</strong>: <code>NA</code> (*not <code>5</code>) - Extinct in the Wild (n=0)</li>
<li>
<strong>EX</strong>: <code>NA</code> (*not <code>5</code>) - EXtinct (n=1)</li>
</ul>
<p>Note that only 1 species is listed as extinct (EX) or extinct in the wild (EW). Since the species is no longer considered present, protection is assumed to not afford any conservation value.</p>
<div id="set-iucn_weight-to-species" class="section level3">
<h3 class="hasAnchor">
<a href="#set-iucn_weight-to-species" class="anchor"></a>Set <code>iucn_weight</code> to species</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">iucn_category_weights =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(
  <span class="dt">DD=</span><span class="ot">NA</span>, 
  <span class="dt">LC=</span><span class="dv">0</span>, <span class="st">`</span><span class="dt">LR/lc</span><span class="st">`</span>=<span class="dv">0</span>, 
  <span class="dt">NT=</span><span class="dv">1</span>, <span class="st">`</span><span class="dt">LR/cd</span><span class="st">`</span>=<span class="dv">1</span>, <span class="st">`</span><span class="dt">LR/nt</span><span class="st">`</span>=<span class="dv">1</span>, 
  <span class="dt">VU=</span><span class="dv">2</span>, 
  <span class="dt">EN=</span><span class="dv">3</span>, 
  <span class="dt">CR=</span><span class="dv">4</span>, 
  <span class="dt">EW=</span><span class="ot">NA</span>,
  <span class="dt">EX=</span><span class="ot">NA</span>)

spp_cols &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/headtail">head</a></span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>()

<span class="cf">if</span> (<span class="op">!</span><span class="st">"iucn_weight"</span> <span class="op">%in%</span><span class="st"> </span>spp_cols){
  
  spp &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">iucn_weight =</span> <span class="kw">recode</span>(iucn_category, <span class="op">!!!</span>iucn_category_weights))
  
  <span class="kw">copy_to</span>(
    con, spp, <span class="st">"spp"</span>, <span class="dt">temporary=</span>F, <span class="dt">overwrite=</span>T,
    <span class="dt">unique_indexes=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"SPECIESID"</span>),
    <span class="dt">indexes =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="st">"group"</span>, <span class="st">"genus_species"</span>, <span class="st">"iucn_weight"</span>))
}

<span class="co"># save spp_csv</span>
<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(spp_csv)){
  <span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">write_csv</span>(spp_csv)
}

spp_iucn_weight &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(iucn_weight)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/table">table</a></span>(spp_iucn_weight, <span class="dt">useNA=</span><span class="st">"always"</span>)</code></pre></div>
<pre><code>## spp_iucn_weight
##     0     1     2     3     4  &lt;NA&gt; 
##  6187   314   379    87    42 17895</code></pre>
</div>
<div id="calculate-rls-all-taxa" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-rls-all-taxa" class="anchor"></a>Calculate <code>rls</code>, all taxa</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells"</span>)

tif &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/rls_all.tif"</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif)){
  
  <span class="co"># calculate RedList sum of weights</span>
  cells_rls &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
          SpeciesID, probability,
          CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"SpeciesID"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      cells, <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CenterLat"</span>,<span class="st">"CenterLong"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">rls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(iucn_weight)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_rls_all &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_rls, <span class="st">"rls"</span>, tif)
}

r_rls_all &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(tif)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_rls_all, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">"Red List Sum, All"</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%20for%20all-1.png" width="700"></p>
</div>
<div id="calculate-rls-by-taxonomic-group" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-rls-by-taxonomic-group" class="anchor"></a>Calculate <code>rls</code>, by taxonomic group</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>F
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells"</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(spp_groups)){
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw"><a href="../reference/group_to_grp.html">group_to_grp</a></span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/rls_{grp}.tif"</span>))
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{str_pad(i, 2, pad='0')} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))
  
  <span class="co"># filter by group</span>
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  spp_grp_w &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/ncell">nrow</a></span>(spp_grp_w) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
    <span class="co">#cat(glue("  all iucn_weight == NA\n", .trim=F))</span>
  } <span class="cf">else</span> {
    <span class="co"># calculate RedList sum of weights</span>
    cells_rls &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
        <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
        iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">left_join</span>(
        spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
            SpeciesID, probability,
            CenterLat, CenterLong) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
            probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
        <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"SpeciesID"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">left_join</span>(
        cells, <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"CenterLat"</span>,<span class="st">"CenterLong"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">summarize</span>(
        <span class="dt">rls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(iucn_weight)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">collect</span>()
    
    r_grp &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_rls, <span class="st">"rls"</span>, tif) 
    <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_grp, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"Red List Sum, {group}"</span>))
  }
}</code></pre></div>
<pre><code>## 02 of 21: chitons - 2019-06-17 14:28:18
## 07 of 21: euphausiids - 2019-06-17 14:28:18
## 09 of 21: hydrozoans - 2019-06-17 14:28:18
## 10 of 21: mangroves - 2019-06-17 14:28:18
## 14 of 21: sea.spiders - 2019-06-17 14:28:18
## 15 of 21: seagrasses - 2019-06-17 14:28:18
## 17 of 21: sponges - 2019-06-17 14:28:18
## 19 of 21: tunicates - 2019-06-17 14:28:18
## 20 of 21: worms - 2019-06-17 14:28:18</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get all tifs, except first one "nspp_all.tif"</span>
tifs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(dir_out, <span class="st">"^rls_.*.tif$"</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_rls &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(tifs)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_rls) &lt;-<span class="st"> </span><span class="kw">str_replace</span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_rls), <span class="st">"rls_"</span>, <span class="st">""</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(s_rls, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%20by%20group-1.png" width="700"></p>
</div>
</div>
<div id="climate-change-forecasts-for-2100" class="section level2">
<h2 class="hasAnchor">
<a href="#climate-change-forecasts-for-2100" class="anchor"></a>Climate Change Forecasts for 2100</h2>
<p>The data from forecasting climate change effects on marine species distributions in 2050 using the AquaMaps model <span class="citation">(Coro et al. 2016)</span> were made publicly available through the server <a href="http://thredds.d4science.org" class="uri">http://thredds.d4science.org</a> and linked from AquaMaps species profiles.</p>
<p>TODO: resolve MISMATCH: - <span class="citation">(Coro et al. 2016)</span>: 2050 - Aquamaps.org: 2100</p>
<p>To investigate accessing these data layers via iMarine, I logged into <a href="https://i-marine.d4science.org/group/biodiversitylab" class="uri">https://i-marine.d4science.org/group/biodiversitylab</a> and see this entry:</p>
<blockquote>
<p>Gianpaolo Coro Dear VRE Members,the AquaMaps Web site is now officially linked to D4Science! All automatically generated maps have links to download content in NetCDF format through D4Science and to interactively inspect the maps trough Web applications hosted by the e-Infrastructure. A total of 24,935 AquaMaps NetCDF files were produced for both today and 2100 through the DataMiner “Csv To NetCDF” conversion algorithms. Please, click on the link below to see an example for yellowback anthias and follow the “NetCDF” and the “view in Godiva” links on the page.</p>
<p><a href="https://www.aquamaps.org/preMap2.php?cache=1&amp;SpecID=Fis-10199" class="uri">https://www.aquamaps.org/preMap2.php?cache=1&amp;SpecID=Fis-10199</a></p>
</blockquote>
<p>Following this link leads to:</p>
<p><a href="http://thredds.d4science.org/thredds/fileServer/public/netcdf/AquaMaps_08_2016/Pseudanthias_evansi.nc" class="uri">http://thredds.d4science.org/thredds/fileServer/public/netcdf/AquaMaps_08_2016/Pseudanthias_evansi.nc</a></p>
<ul>
<li>Computer Generated Native Distribution Map for {sp}, with modelled year 2100 native range map based on IPCC A2 emissions scenario</li>
<li>
<strong>Cite this set of maps as</strong>: Computer generated distribution maps for <em>{Genus} {species}</em> ({common}), with modelled year 2100 native range map based on IPCC A2 emissions scenario. www.aquamaps.org, version of Aug. 2016. Web. Accessed 10 Jun. 2019.</li>
</ul>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(raster)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(glue)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(here)

get_am2100nc &lt;-<span class="st"> </span><span class="cf">function</span>(sp, nc){
  <span class="co"># sp &lt;- "Acanthopagrus_berda"</span>
  <span class="co"># nc &lt;- file.path(dir_nc, basename(url)) # unlink(nc)</span>
  
  <span class="co"># get netcdf file</span>
  url &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"http://thredds.d4science.org/thredds/fileServer/public/netcdf/AquaMaps_08_2016/{sp}.nc"</span>)
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(nc)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{sp}: already exists"</span>))
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(
    <span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/download.file">download.file</a></span>(url, nc, <span class="dt">mode =</span> <span class="st">"wb"</span>, <span class="dt">quiet =</span> T),
    <span class="dt">error=</span><span class="cf">function</span>(e) e)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{sp}: {ifelse(file.exists(nc), 'downloaded', 'missing')}"</span>))
    <span class="co">#spp_2100 &lt;- spp_2100 %&gt;% </span>
    <span class="co">#  mutate(</span>
    <span class="co">#    downloaded = ifelse(sp_str == sp, file.exists(nc), downloaded))</span>
    <span class="co"># head(spp_2100)</span>
  <span class="co">#sp_downloaded &lt;- filter(spp_2100, sp_str == sp) %&gt;% pull(downloaded)</span>
  <span class="co">#return(glue("{sp}: {sp_downloaded}"))</span>
}

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(spp_2100_csv)){
  <span class="co"># get all species</span>
  spp_<span class="dv">2100</span> &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(SPECIESID, Genus, Species) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">mutate</span>(
      <span class="dt">sp_str     =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{Genus}_{Species}"</span>),
      <span class="dt">path_nc    =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_nc}/{sp_str}.nc"</span>),
      <span class="dt">downloaded =</span> <span class="ot">NA</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">arrange</span>(sp_str) <span class="co"># n= 24,894</span>

  <span class="kw">plan</span>(multiprocess)
  
  <span class="co"># iterate in chunks of 1000</span>
  n &lt;-<span class="st"> </span><span class="dv">1000</span>
  <span class="cf">for</span> ( i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq</a></span>(<span class="dv">1</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/ncell">nrow</a></span>(spp_<span class="dv">2100</span>), <span class="dt">by=</span>n) ){ <span class="co"># i = 1</span>
    
    i_beg &lt;-<span class="st"> </span>i
    i_end &lt;-<span class="st"> </span>i <span class="op">-</span><span class="st"> </span><span class="dv">1</span> <span class="op">+</span><span class="st"> </span>n
    csv &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dirname(dir_nc)}/spp_2100_{str_pad(i_beg, 5, 'left', '0')}-{str_pad(i_end, 5, 'left', '0')}.csv"</span>)
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{basename(csv)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))
    
    <span class="co"># speed up fetching by running in parallel</span>
    <span class="kw"><a href="https://www.rdocumentation.org/packages/furrr/topics/future_map2">future_map2_chr</a></span>(
      spp_<span class="dv">2100</span><span class="op">$</span>sp_str[i_beg<span class="op">:</span>i_end], 
      spp_<span class="dv">2100</span><span class="op">$</span>path_nc[i_beg<span class="op">:</span>i_end],
      get_am2100nc)
    
    <span class="co"># record species searched and not found</span>
    spp_i &lt;-<span class="st"> </span><span class="kw">slice</span>(spp_<span class="dv">2100</span>, i_beg<span class="op">:</span>i_end) <span class="op">%&gt;%</span><span class="st">  </span>
<span class="st">      </span><span class="kw">mutate</span>(
        <span class="dt">downloaded =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(path_nc)) <span class="co"># View(spp_i)</span>
    <span class="kw">write_csv</span>(spp_i, csv)
  }
  
  <span class="co"># combine temporary csvs</span>
  csvs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/basename">dirname</a></span>(dir_nc), <span class="st">"*</span><span class="ch">\\</span><span class="st">.csv"</span>, <span class="dt">full.names =</span> T)
  spp_df &lt;-<span class="st"> </span><span class="kw">map_df</span>(csvs, read_csv) <span class="op">%&gt;%</span><span class="st"> </span>dplyr<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/dplyr/topics/bind">bind_rows</a></span>() <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/duplicated">duplicated</a></span>(sp_str))
  <span class="kw">write_csv</span>(spp_df, spp_2100_csv)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlink">unlink</a></span>(csvs)
}

<span class="co"># quickfix</span>
<span class="co"># spp_df2 &lt;- spp_df %&gt;% </span>
<span class="co">#   left_join(</span>
<span class="co">#     spp_2100 %&gt;% </span>
<span class="co">#       select(sp_str, SPECIESID),</span>
<span class="co">#     by="sp_str") %&gt;% </span>
<span class="co">#   select(SPECIESID, Genus, Species, sp_str, path_nc, downloaded)</span>
<span class="co"># write_csv(spp_df2, spp_2100_csv)</span>


<span class="cf">if</span> (<span class="op">!</span><span class="st">"spp_cells_2100"</span> <span class="op">%in%</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbListTables">dbListTables</a></span>(con)){
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbExecute">dbExecute</a></span>(con, <span class="st">'CREATE TABLE spp_cells_2100 (</span>
<span class="st">  speciesid text,</span>
<span class="st">  cellid int4,</span>
<span class="st">  probability float8);</span>
<span class="st">  CREATE UNIQUE INDEX idx_spp_cells_2100_unique ON spp_cells_2100 (speciesid, cellid);'</span>)
  
  r_na   &lt;-<span class="st"> </span><span class="kw"><a href="../reference/raster_na.html">raster_na</a></span>()
  spp_df &lt;-<span class="st"> </span><span class="kw">read_csv</span>(spp_2100_csv) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(downloaded) <span class="co"># 24894 - 24831 = 63 unavailable</span>
  <span class="co"># of 24,894 spp: 63 unavailable, 20 mismatch and 5 unreadable</span>

  <span class="co">#for (i in 1:nrow(spp_df)){ # i = 1087</span>
  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">18009</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/ncell">nrow</a></span>(spp_df)){ <span class="co"># i = 18009</span>
    <span class="cf">if</span> (i <span class="op">%%</span><span class="st"> </span><span class="dv">1000</span> <span class="op">==</span><span class="st"> </span><span class="dv">0</span>) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{sprintf('%06d',i)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))
    
    nc    &lt;-<span class="st"> </span>spp_df<span class="op">$</span>path_nc[i]
    sp_id &lt;-<span class="st"> </span>spp_df<span class="op">$</span>SPECIESID[i]
    
    <span class="co">#r &lt;- raster(nc, varname="probability")</span>
    r &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(nc, <span class="dt">varname=</span><span class="st">"probability"</span>),
      <span class="dt">error =</span> <span class="cf">function</span>(e) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
        <span class="st">"  can't read {sprintf('%06d',i)} {sp_id} {basename(nc)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>)))
    <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(r)) <span class="cf">next</span>
    
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/conditions">tryCatch</a></span>(
      <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/compare">compareRaster</a></span>(
        r, r_na, 
        <span class="dt">extent=</span>F, <span class="dt">rowcol=</span>F, 
        <span class="dt">crs=</span>T, <span class="dt">res=</span>T, <span class="dt">orig=</span>T, <span class="dt">rotation=</span>T),
      <span class="dt">error =</span> <span class="cf">function</span>(e) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(
        <span class="st">"  mismatch {sprintf('%06d',i)} {sp_id} {basename(nc)} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>)))
    <span class="co"># i = 1087  # 2019-06-10 00:03:23</span>
    <span class="co"># Error in compareRaster(): different resolution</span>
    <span class="co">#   extent      : -81, -78, -37.5, -15  (xmin, xmax, ymin, ymax)</span>
    <span class="co">#   data source : /Users/bbest/docker_pg_data/aquamaps2100_nc/Amphichaetodon_melbae.nc </span>
    <span class="co"># mismatch 001087 Fis-33857 Amphichaetodon_melbae.nc - 2019-06-10 00:15:56</span>
    <span class="co"># mismatch 001433 URM-2-1014 Anoplodactylus_laminifer.nc - 2019-06-10 00:17:01</span>
    <span class="co"># mismatch 003352 Fis-144824 Bovichtus_veneris.nc - 2019-06-10 00:23:45</span>
    <span class="co"># mismatch 004814 NZ-24280 Charitometra_incisa.nc - 2019-06-10 00:28:13</span>
    <span class="co"># mismatch 005270 Fis-60663 Chromis_pamae.nc - 2019-06-10 00:29:39</span>
    <span class="co"># mismatch 007885 Fis-147877 Ebinania_macquariensis.nc - 2019-06-10 00:37:37</span>
    <span class="co"># mismatch 009752 Fis-27991 Genicanthus_semicinctus.nc - 2019-06-10 00:42:44</span>
    <span class="co"># mismatch 009852 Fis-134861 Girella_albostriata.nc - 2019-06-10 00:43:03</span>
    <span class="co"># mismatch 011115 URM-2-3593 Heterostigma_singulare.nc - 2019-06-10 00:46:36</span>
    <span class="co"># mismatch 011989 ITS-552955 Jasus_paulensis.nc - 2019-06-10 00:49:06</span>
    <span class="co"># mismatch 012027 W-Iso-256075 Joeropsis_sanctipauli.nc - 2019-06-10 00:49:11</span>
    <span class="co"># mismatch 014326 SLB-142070 Microdictyon_okamurae.nc - 2019-06-10 00:55:57</span>
    <span class="co"># mismatch 015881 Fis-168180 Novaculops_koteamea.nc - 2019-06-10 06:00:43</span>
    <span class="co"># mismatch 016386 Fis-130905 Ophichthus_kunaloa.nc - 2019-06-10 06:02:24</span>
    <span class="co"># mismatch 016430 Fis-133519 Ophidion_metoecus.nc - 2019-06-10 06:02:30</span>
    <span class="co"># mismatch 017495 Fis-123220 Parapercis_dockinsi.nc - 2019-06-10 06:05:43</span>
    <span class="co"># mismatch 020940 Fis-153727 Scartella_poiti.nc - 2019-06-10 07:21:30</span>
    <span class="co"># mismatch 020942 Fis-61194 Scartichthys_variolatus.nc - 2019-06-10 07:21:30</span>
    <span class="co"># mismatch 022003 Fis-164212 Sparisoma_rocha.nc - 2019-06-10 07:24:20</span>
    <span class="co"># mismatch 023107 URM-2-336 Tanystylum_beuroisi.nc - 2019-06-10 07:27:33</span>
    <span class="co"># mismatch rasters: n=20</span>
    
    <span class="co"># i = 17793 Patagonotothen_sima.nc</span>
    <span class="co"># Error in .local(x, ...) : min and max x are the same</span>
    <span class="co"># 128-111-61-209:aquamaps2100_nc bbest$ gdalinfo Patagonotothen_sima.nc</span>
    <span class="co"># Warning 1: No UNIDATA NC_GLOBAL:Conventions attribute</span>
    <span class="co"># Driver: netCDF/Network Common Data Format</span>
    <span class="co"># Files: Patagonotothen_sima.nc</span>
    <span class="co"># Size is 512, 512</span>
    <span class="co"># Coordinate System is `'</span>
    <span class="co"># Subdatasets:</span>
    <span class="co">#   SUBDATASET_1_NAME=NETCDF:"Patagonotothen_sima.nc":probability</span>
    <span class="co">#   SUBDATASET_1_DESC=[107x66] probability (64-bit floating-point)</span>
    <span class="co">#   SUBDATASET_2_NAME=NETCDF:"Patagonotothen_sima.nc":faoareayn</span>
    <span class="co">#   SUBDATASET_2_DESC=[107x66] faoareayn (32-bit integer)</span>
    <span class="co">#   SUBDATASET_3_NAME=NETCDF:"Patagonotothen_sima.nc":boundboxyn</span>
    <span class="co">#   SUBDATASET_3_DESC=[107x66] boundboxyn (32-bit integer)</span>
    <span class="co"># Corner Coordinates:</span>
    <span class="co"># Upper Left  (    0.0,    0.0)</span>
    <span class="co"># Lower Left  (    0.0,  512.0)</span>
    <span class="co"># Upper Right (  512.0,    0.0)</span>
    <span class="co"># Lower Right (  512.0,  512.0)</span>
    <span class="co"># Center      (  256.0,  256.0)</span>
    <span class="co"># can't read 17793 ? Patagonotothen_sima.nc</span>
    <span class="co"># can't read 018009 ITS-612391 Periclimenes_brevicarpalis.nc - 2019-06-10 07:12:45</span>
    <span class="co"># can't read 018176 W-Por-246569 Phakellia_columnata.nc - 2019-06-10 07:13:18</span>
    <span class="co"># can't read 018009 ITS-612391 Periclimenes_brevicarpalis.nc - 2019-06-10 07:12:45</span>
    <span class="co"># can't read 018176 W-Por-246569 Phakellia_columnata.nc - 2019-06-10 07:13:18</span>
    <span class="co"># can't read rasters: n=5    </span>
    
    <span class="co">#r &lt;- extend(r, r_na)</span>
    r &lt;-<span class="st"> </span>raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/projectRaster">projectRaster</a></span>(r, r_na)
    d &lt;-<span class="st"> </span><span class="kw">tibble</span>(
      <span class="dt">speciesid =</span> sp_id,
      <span class="dt">probability =</span> raster<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/getValues">values</a></span>(r)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span>tibble<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/tibble/topics/rownames">rowid_to_column</a></span>(<span class="dt">var =</span> <span class="st">"cellid"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(probability))
    
    <span class="co">#dbExecute(con, glue("DELETE FROM spp_cells_2100;"))</span>
    <span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbExecute">dbExecute</a></span>(con, <span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"DELETE FROM spp_cells_2100 WHERE SpeciesID='{sp_id}';"</span>))
    <span class="kw"><a href="https://www.rdocumentation.org/packages/DBI/topics/dbWriteTable">dbWriteTable</a></span>(con, <span class="st">"spp_cells_2100"</span>, d, <span class="dt">append=</span>T, <span class="dt">row.names=</span>F)
  }
  <span class="co"># i = 1</span>
}  </code></pre></div>
<div id="calculate-species-richness-1" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-species-richness-1" class="anchor"></a>Calculate species richness</h3>
<div id="calculate-nspp-all-taxa-1" class="section level4">
<h4 class="hasAnchor">
<a href="#calculate-nspp-all-taxa-1" class="anchor"></a>Calculate <code>nspp</code>, all taxa</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp_prob_threshold &lt;-<span class="st"> </span><span class="fl">0.5</span>

spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells_2100"</span>)

tif &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/nspp_all_2100.tif"</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif)){
  
  <span class="co"># get species richness, with default col_cellid="cellid"</span>
  cells_nspp &lt;-<span class="st"> </span>spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_nspp_all_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_nspp, <span class="st">"nspp"</span>, tif)
}

r_nspp_all_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(tif)

<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_nspp_all_<span class="dv">2100</span>, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">"Species Richness, All 2100"</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%202100%20for%20all-1.png" width="700"></p>
</div>
<div id="calculate-nspp-by-taxonomic-group-1" class="section level4">
<h4 class="hasAnchor">
<a href="#calculate-nspp-by-taxonomic-group-1" class="anchor"></a>Calculate <code>nspp</code>, by taxonomic group</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>F
<span class="co">#options(warn=2) # error on warning</span>
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells_2100"</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(spp_groups)){ <span class="co"># i = 1</span>
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw"><a href="../reference/group_to_grp.html">group_to_grp</a></span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/nspp_{grp}_2100.tif"</span>))
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{str_pad(i, 2, pad='0')} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))

  <span class="co"># get species diversity, with default col_cellid="cellid"</span>
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  cells_nspp_<span class="dv">2100</span> &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(SPECIESID) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
          speciesid, cellid, probability) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"speciesid"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">nspp =</span> <span class="kw">n</span>()) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_grp_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_nspp_<span class="dv">2100</span>, <span class="st">"nspp"</span>, tif)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_grp_<span class="dv">2100</span>, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"nspp {group} 2100"</span>))
}

<span class="co"># get all tifs, except first one "nspp_all_2100.tif"</span>
tifs   &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(dir_out, <span class="st">"^nspp_.*_2100</span><span class="ch">\\</span><span class="st">.tif$"</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_nspp_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(tifs)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_nspp_<span class="dv">2100</span>) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_nspp_<span class="dv">2100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_replace</span>(<span class="st">"nspp_"</span>, <span class="st">""</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_replace</span>(<span class="st">"_2100"</span>, <span class="st">""</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(s_nspp_<span class="dv">2100</span>, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20nspp%202100%20by%20group-1.png" width="700"></p>
</div>
</div>
<div id="calculate-extinction-risk-1" class="section level3">
<h3 class="hasAnchor">
<a href="#calculate-extinction-risk-1" class="anchor"></a>Calculate extinction risk</h3>
<div id="calculate-rls-all-taxa-1" class="section level4">
<h4 class="hasAnchor">
<a href="#calculate-rls-all-taxa-1" class="anchor"></a>Calculate <code>rls</code>, all taxa</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells_2100"</span>)

tif &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/rls_all_2100.tif"</span>))

<span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif)){
  
  <span class="co"># calculate RedList sum of weights</span>
  cells_rls_<span class="dv">2100</span> &lt;-<span class="st"> </span>spp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">left_join</span>(
      spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
          speciesid, cellid, probability) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
          probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
      <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"speciesid"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">summarize</span>(
      <span class="dt">rls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(iucn_weight, <span class="dt">na.rm=</span>T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  r_rls_all_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_rls_<span class="dv">2100</span>, <span class="st">"rls"</span>, tif)
}

r_rls_all_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/raster">raster</a></span>(tif)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_rls_all_<span class="dv">2100</span>, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="st">"Red List Sum, All 2100"</span>)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%202100%20for%20all-1.png" width="700"></p>
</div>
<div id="calculate-rls-by-taxonomic-group-1" class="section level4">
<h4 class="hasAnchor">
<a href="#calculate-rls-by-taxonomic-group-1" class="anchor"></a>Calculate <code>rls</code>, by taxonomic group</h4>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">redo      &lt;-<span class="st"> </span>F
spp       &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>)
cells     &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"cells"</span>)
spp_cells &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp_cells_2100"</span>)

spp_groups &lt;-<span class="st"> </span><span class="kw">tbl</span>(con, <span class="st">"spp"</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">arrange</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">distinct</span>(group) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">pull</span>(group)

<span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_along</a></span>(spp_groups)){ <span class="co"># i = 1</span>
  group &lt;-<span class="st"> </span>spp_groups[i]
  grp   &lt;-<span class="st"> </span><span class="kw"><a href="../reference/group_to_grp.html">group_to_grp</a></span>(group)
  tif   &lt;-<span class="st"> </span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{dir_out}/rls_{grp}_2100.tif"</span>))
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/files">file.exists</a></span>(tif) <span class="op">&amp;</span><span class="st"> </span><span class="op">!</span>redo) <span class="cf">next</span>()
  
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"{str_pad(i, 2, pad='0')} of {length(spp_groups)}: {grp} - {Sys.time()}</span><span class="ch">\n\n</span><span class="st">"</span>))
  
  <span class="co"># filter by group</span>
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group)){
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(group))
  } <span class="cf">else</span>{
    spp_grp &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(spp, group <span class="op">==</span><span class="st"> </span><span class="op">!!</span>group)
  }
  
  spp_grp_w &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
      <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
      iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">    </span><span class="kw">collect</span>()
  
  <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/ncell">nrow</a></span>(spp_grp_w) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>){
    <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/cat">cat</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"  all iucn_weight == NA</span><span class="ch">\n</span><span class="st">"</span>, <span class="dt">.trim=</span>F))
  } <span class="cf">else</span> {
    <span class="co"># calculate RedList sum of weights</span>
    cells_rls_<span class="dv">2100</span> &lt;-<span class="st"> </span>spp_grp <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
        <span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(iucn_weight), 
        iucn_weight <span class="op">!=</span><span class="st"> </span><span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">left_join</span>(
        spp_cells <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/select">select</a></span>(
            speciesid, cellid, probability) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">          </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(
            probability <span class="op">&gt;=</span><span class="st"> </span>spp_prob_threshold), 
        <span class="dt">by=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"SPECIESID"</span>=<span class="st">"speciesid"</span>)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">group_by</span>(cellid) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">summarize</span>(
        <span class="dt">rls =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(iucn_weight, <span class="dt">na.rm =</span> T)) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">      </span><span class="kw">collect</span>()
    
    r_grp_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="../reference/df_to_raster.html">df_to_raster</a></span>(cells_rls_<span class="dv">2100</span>, <span class="st">"rls"</span>, tif) 
    <span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(r_grp_<span class="dv">2100</span>, <span class="dt">col =</span> cols, <span class="dt">main=</span><span class="kw"><a href="https://www.rdocumentation.org/packages/glue/topics/glue">glue</a></span>(<span class="st">"Red List Sum, {group} 2100"</span>))
  }
}</code></pre></div>
<pre><code>## 02 of 21: chitons - 2019-06-17 14:28:26
##   all iucn_weight == NA
## 07 of 21: euphausiids - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 09 of 21: hydrozoans - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 10 of 21: mangroves - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 14 of 21: sea.spiders - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 15 of 21: seagrasses - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 17 of 21: sponges - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 19 of 21: tunicates - 2019-06-17 14:28:27
##   all iucn_weight == NA
## 20 of 21: worms - 2019-06-17 14:28:27
##   all iucn_weight == NA</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># get all tifs, except first one "rls_all_2100.tif"</span>
tifs   &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list.files">list.files</a></span>(dir_out, <span class="st">"^rls_.*_2100</span><span class="ch">\\</span><span class="st">.tif$"</span>, <span class="dt">full.names =</span> T)[<span class="op">-</span><span class="dv">1</span>]
s_rls_<span class="dv">2100</span> &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/stack">stack</a></span>(tifs)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_rls_<span class="dv">2100</span>) &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/names">names</a></span>(s_rls_<span class="dv">2100</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_replace</span>(<span class="st">"rls_"</span>, <span class="st">""</span>) <span class="op">%&gt;%</span><span class="st"> </span>
<span class="st">  </span><span class="kw">str_replace</span>(<span class="st">"_2100"</span>, <span class="st">""</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/raster/topics/plot">plot</a></span>(s_rls_<span class="dv">2100</span>, <span class="dt">col =</span> cols)</code></pre></div>
<p><img src="calc_files/figure-html/calc%20rls%202100%20by%20group-1.png" width="700"></p>
</div>
</div>
</div>
<div id="todo-archive-db" class="section level2">
<h2 class="hasAnchor">
<a href="#todo-archive-db" class="anchor"></a>TODO: Archive DB</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## <span class="al">TODO</span>: Archive db

<span class="co"># [arkdb](https://ropensci.github.io/arkdb/): archive and unarchive databases using flat files</span></code></pre></div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-butchartImprovementsRedList2007">
<p>Butchart, Stuart H. M., H. Resit Akçakaya, Janice Chanson, Jonathan E. M. Baillie, Ben Collen, Suhel Quader, Will R. Turner, Rajan Amin, Simon N. Stuart, and Craig Hilton-Taylor. 2007. “Improvements to the Red List Index.” <em>PLOS ONE</em> 2 (1): e140. doi:<a href="https://doi.org/10.1371/journal.pone.0000140">10.1371/journal.pone.0000140</a>.</p>
</div>
<div id="ref-coroAutomaticClassificationClimate2016">
<p>Coro, Gianpaolo, Chiara Magliozzi, Anton Ellenbroek, Kristin Kaschner, and Pasquale Pagano. 2016. “Automatic Classification of Climate Change Effects on Marine Species Distributions in 2050 Using the AquaMaps Model.” <em>Environ Ecol Stat</em> 23 (1): 155–80. doi:<a href="https://doi.org/10.1007/s10651-015-0333-8">10.1007/s10651-015-0333-8</a>.</p>
</div>
<div id="ref-juslenApplicationRedList2016">
<p>Juslén, Aino, Juha Pykälä, Saija Kuusela, Lauri Kaila, Jaakko Kullberg, Jaakko Mattila, Jyrki Muona, Sanna Saari, and Pedro Cardoso. 2016. “Application of the Red List Index as an Indicator of Habitat Change.” <em>Biodivers Conserv</em> 25 (3): 569–85. doi:<a href="https://doi.org/10.1007/s10531-016-1075-0">10.1007/s10531-016-1075-0</a>.</p>
</div>
<div id="ref-kaschnerAquaMapsPredictedRange2016">
<p>Kaschner, K., K. Kesner-Reyes, C. Garilao, J. Rius-Barile, T. Rees, and R. Froese. 2016. “AquaMaps: Predicted Range Maps for Aquatic Species.” World Wide Web Electronic Publication.</p>
</div>
<div id="ref-kleinShortfallsGlobalProtected2015">
<p>Klein, Carissa J., Christopher J. Brown, Benjamin S. Halpern, Daniel B. Segan, Jennifer McGowan, Maria Beger, and James E. M. Watson. 2015. “Shortfalls in the Global Protected Area Network at Representing Marine Biodiversity.” <em>Scientific Reports</em> 5 (December): 17539. doi:<a href="https://doi.org/10.1038/srep17539">10.1038/srep17539</a>.</p>
</div>
<div id="ref-oharaAligningMarineSpecies2017">
<p>O’Hara, Casey C., Jamie C. Afflerbach, Courtney Scarborough, Kristin Kaschner, and Benjamin S. Halpern. 2017. “Aligning Marine Species Range Data to Better Serve Science and Conservation.” <em>PLOS ONE</em> 12 (5): e0175739. doi:<a href="https://doi.org/10.1371/journal.pone.0175739">10.1371/journal.pone.0175739</a>.</p>
</div>
<div id="ref-tittensorGlobalPatternsPredictors2010">
<p>Tittensor, Derek P., Camilo Mora, Walter Jetz, Heike K. Lotze, Daniel Ricard, Edward Vanden Berghe, and Boris Worm. 2010. “Global Patterns and Predictors of Marine Biodiversity Across Taxa.” <em>Nature</em> 466 (7310): 1098–1101. doi:<a href="https://doi.org/10.1038/nature09329">10.1038/nature09329</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#setup-database">Setup database</a></li>
      <li><a href="#connect-to-database">Connect to database</a></li>
      <li><a href="#load-aquamaps-csvs-into-database">Load AquaMaps csvs into database</a></li>
      <li><a href="#assign-taxonomic-groups">Assign taxonomic groups</a></li>
      <li><a href="#get-extinction-risk-from-iucn">Get extinction risk from IUCN</a></li>
      <li><a href="#calculate-species-richness">Calculate species richness</a></li>
      <li><a href="#calculate-extinction-risk">Calculate extinction risk</a></li>
      <li><a href="#climate-change-forecasts-for-2100">Climate Change Forecasts for 2100</a></li>
      <li><a href="#todo-archive-db">TODO: Archive DB</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Ben Best.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
